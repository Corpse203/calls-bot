<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calls Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    .fade-out {
      opacity: 0;
      transform: translateX(40px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="flex flex-col justify-between min-h-screen bg-gray-950 text-white p-6 font-sans">

  <!-- ‚úÖ Badge admin status -->
  <div id="adminStatus" class="fixed top-2 right-4 text-sm px-3 py-1 rounded-full font-medium shadow bg-red-600 text-white z-50">
    üîí Non connect√©
  </div>

  <div class="max-w-2xl mx-auto text-center">
    <h1 class="text-4xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-indigo-400">
      üé∞ Liste des Calls - DLive
    </h1>

    <!-- üéØ Formulaire PUBLIC -->
    <div id="viewerForm" class="mb-8">
      <h2 class="text-xl font-bold mb-2">üì© Proposer une machine</h2>
      <form onsubmit="submitViewerCall(event)" class="flex flex-col md:flex-row gap-2 justify-center">
        <input id="slotInput" type="text" placeholder="Nom de la slot"
               class="p-2 rounded bg-gray-800 text-white border border-gray-700 focus:ring focus:ring-blue-500" required />
        <input id="userInput" type="text" placeholder="Ton pseudo"
               class="p-2 rounded bg-gray-800 text-white border border-gray-700 focus:ring focus:ring-blue-500" required />
        <button type="submit"
                class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded font-semibold transition">
          Envoyer
        </button>
      </form>
    </div>

    <!-- üîê Zone admin -->
    <div id="loginForm" class="mb-6 hidden">
      <input id="passwordInput" type="password" placeholder="Mot de passe admin"
             class="p-2 rounded bg-gray-800 text-white border border-gray-700 focus:ring-2 focus:ring-blue-500"/>
      <button onclick="login()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 ml-2 rounded transition">Connexion</button>
    </div>

    <button id="logoutBtn" onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded mb-4 hidden transition">Se d√©connecter</button>
    <button id="resetBtn" onclick="resetCalls()" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded mb-6 text-black font-semibold transition hidden">
      üßΩ Vider la liste
    </button>

    <!-- üìã Liste des calls -->
    <ul id="callList" class="space-y-4 mt-4"></ul>
  </div>

  <!-- üë£ Footer personnalis√© -->
  <footer class="mt-16 text-center text-sm text-gray-400 hover:text-white transition-opacity opacity-70">
    D√©velopp√© avec ‚ù§Ô∏è par <span class="text-purple-400 font-semibold">Browkse</span>
  </footer>

  <script>
    let isAdmin = false;
    const callList = document.getElementById("callList");
    const adminStatus = document.getElementById("adminStatus");

    const evtSource = new EventSource("/events");
    evtSource.onmessage = function (event) {
      const data = JSON.parse(event.data);
      renderCalls(data.calls);
    };

    function renderCalls(calls) {
      document.getElementById("loginForm").classList.toggle("hidden", isAdmin);
      document.getElementById("logoutBtn").classList.toggle("hidden", !isAdmin);
      document.getElementById("resetBtn").classList.toggle("hidden", !isAdmin);

      // üîÑ Affiche le statut admin
      if (isAdmin) {
        adminStatus.textContent = "‚úÖ Admin connect√©";
        adminStatus.className = "fixed top-2 right-4 text-sm px-3 py-1 rounded-full font-medium shadow bg-green-600 text-white z-50";
      } else {
        adminStatus.textContent = "üîí Non connect√©";
        adminStatus.className = "fixed top-2 right-4 text-sm px-3 py-1 rounded-full font-medium shadow bg-red-600 text-white z-50";
      }

      // üîÅ Affiche les calls
      callList.innerHTML = "";
      calls.forEach((call, index) => {
        const li = document.createElement("li");
        li.className = "fade-in bg-gradient-to-br from-indigo-600 via-purple-600 to-blue-500 p-4 rounded-2xl shadow-lg flex justify-between items-center";

        li.innerHTML = `
          <div class="text-left">
            <p class="text-xl font-semibold">üé∞ ${call.slot}</p>
            <p class="text-sm text-gray-100">üë§ ${call.user}</p>
          </div>
          ${isAdmin ? `
            <button onclick="deleteCall(${index})"
              class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm font-bold transition">
              Supprimer
            </button>` : ""}
        `;
        callList.appendChild(li);
      });
    }

    async function login() {
      const password = document.getElementById("passwordInput").value;
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password }),
      });
      if (!res.ok) alert("‚ùå Mot de passe incorrect");
    }

    async function logout() {
      await fetch("/api/logout", { method: "POST" });
    }

    async function deleteCall(index) {
      const li = document.querySelectorAll("#callList li")[index];
      li.classList.add("fade-out");
      setTimeout(async () => {
        await fetch("/api/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ index }),
        });
      }, 400);
    }

    async function resetCalls() {
      const confirmReset = confirm("‚ö†Ô∏è Es-tu s√ªr de vouloir VIDER toute la liste ?");
      if (!confirmReset) return;
      await fetch("/api/reset", { method: "POST" });
    }

    async function submitViewerCall(event) {
      event.preventDefault();

      const slot = document.getElementById("slotInput").value.trim();
      const user = document.getElementById("userInput").value.trim();
      if (!slot || !user) return alert("Remplis les deux champs !");

      const res = await fetch("/api/call", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ slot, user }),
      });

      if (res.ok) {
        document.getElementById("slotInput").value = "";
        document.getElementById("userInput").value = "";
      } else {
        alert("Erreur lors de l'envoi du call !");
      }
    }
  </script>
</body>
</html>
