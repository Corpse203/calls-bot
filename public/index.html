<!DOCTYPE html>
<html lang="fr">
$1
  
</head>
<body class="flex flex-col justify-between min-h-screen bg-gradient-to-b from-gray-950 to-gray-900 text-white p-6 font-sans relative">

  <!-- ‚úÖ Notification toast -->
  <div id="notif" class="fixed top-4 left-1/2 -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded shadow hidden z-50">
    Call ajout√© avec succ√®s ‚úÖ
  </div>

  <!-- ‚úÖ Badge admin status -->
  <div id="adminStatus" class="fixed top-2 right-4 text-sm px-3 py-1 rounded-full font-medium shadow bg-red-600 text-white z-50">
    üîí Non connect√©
  </div>

  <div class="max-w-2xl mx-auto text-center">
    <h1 class="text-4xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-indigo-400">
      üé∞ Liste des Calls - DLive
    </h1>

    <!-- üìä Compteur des calls -->
    <div id="callCounter" class="text-sm text-gray-400 mb-4"></div>

    <!-- üéØ Formulaire PUBLIC -->
    <div id="viewerForm" class="mb-8 bg-black/20 p-4 rounded-lg shadow-inner">
      <h2 class="text-xl font-bold mb-2 text-white">üì© Proposer une machine</h2>
      <form onsubmit="submitViewerCall(event)" class="flex flex-col md:flex-row gap-2 justify-center">
        <div class="relative w-full md:w-auto">
          <input id="slotInput" type="text" placeholder="Nom de la slot"
                 class="pl-10 p-2 rounded bg-gray-800 text-white border border-gray-700 focus:ring focus:ring-blue-500 w-full" required />
          <span class="absolute left-3 top-1.5 text-lg">üé∞</span>
        </div>
        <div class="relative w-full md:w-auto">
          <input id="userInput" type="text" placeholder="Ton pseudo"
                 class="pl-10 p-2 rounded bg-gray-800 text-white border border-gray-700 focus:ring focus:ring-blue-500 w-full" required />
          <span class="absolute left-3 top-1.5 text-lg">üë§</span>
        </div>
        <button type="submit"
                class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded font-semibold transition">
          Envoyer
        </button>
      </form>
    </div>

    <!-- üîê Zone admin -->
    <div id="loginForm" class="mb-6 hidden">
      <input id="passwordInput" type="password" placeholder="Mot de passe admin"
             class="p-2 rounded bg-gray-800 text-white border border-gray-700 focus:ring-2 focus:ring-blue-500"/>
      <button onclick="login()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 ml-2 rounded transition">Connexion</button>
    </div>

    <button id="logoutBtn" onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded mb-4 hidden transition">Se d√©connecter</button>
    <button id="resetBtn" onclick="resetCalls()" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded mb-6 text-black font-semibold transition hidden">
      üßΩ Vider la liste
    </button>

    <!-- üìã Liste des calls -->
    <ul id="callList" class="space-y-4 mt-4"></ul>
  </div>

  <!-- üë£ Footer personnalis√© -->
  <footer class="mt-16 text-center text-sm text-gray-400 hover:text-white transition-opacity opacity-70">
    D√©velopp√© avec ‚ù§Ô∏è par <span class="text-purple-400 font-semibold">Browkse</span>
  </footer>

  <script>
    let isAdmin = false;
    const callList = document.getElementById("callList");
    const adminStatus = document.getElementById("adminStatus");
    const notif = document.getElementById("notif");
    const callCounter = document.getElementById("callCounter");
    const loginForm = document.getElementById("loginForm");
    const logoutBtn = document.getElementById("logoutBtn");
    const resetBtn = document.getElementById("resetBtn");

    const evtSource = new EventSource("/events");
    evtSource.onmessage = function (event) {
      const data = JSON.parse(event.data);
      isAdmin = data.admin ?? false;
      renderCalls(data.calls);
    };

    function showNotif(msg) {
      notif.textContent = msg;
      notif.classList.remove("hidden");
      setTimeout(() => notif.classList.add("hidden"), 3000);
    }

    function renderCalls(calls) {
      loginForm.classList.toggle("hidden", isAdmin);
      logoutBtn.classList.toggle("hidden", !isAdmin);
      resetBtn.classList.toggle("hidden", !isAdmin);

      if (isAdmin) {
        adminStatus.textContent = "‚úÖ Admin connect√©";
        adminStatus.className = "fixed top-2 right-4 text-sm px-3 py-1 rounded-full font-medium shadow bg-green-600 text-white z-50";
      } else {
        adminStatus.textContent = "üîí Non connect√©";
        adminStatus.className = "fixed top-2 right-4 text-sm px-3 py-1 rounded-full font-medium shadow bg-red-600 text-white z-50";
      }

      callCounter.textContent = `üìã ${calls.length} call${calls.length === 1 ? '' : 's'} en attente`;

      callList.innerHTML = "";
      calls.forEach((call, index) => {
        const li = document.createElement("li");
        li.className = "fade-in bg-gradient-to-br from-indigo-600 via-purple-600 to-blue-500 p-4 rounded-2xl shadow-lg flex justify-between items-center";
        li.innerHTML = `
          <div class="text-left">
            <p class="text-xl font-semibold">üé∞ ${call.slot}</p>
            <p class="text-sm text-gray-100">üë§ ${call.user}</p>
          </div>
          ${isAdmin ? `
            <button onclick="deleteCall(${index})"
              class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm font-bold transition">
              Supprimer
            </button>` : ""}
        `;
        callList.appendChild(li);
      });
    }

    async function login() {
      const password = document.getElementById("passwordInput").value;
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password })
      });

      if (!res.ok) {
        alert("‚ùå Mot de passe incorrect");
      } else {
        isAdmin = true;
        const res2 = await fetch('/api/calls');
        const data = await res2.json();
        renderCalls(data.calls);
      }
    }

    async function logout() {
      await fetch("/api/logout", { method: "POST" });
      isAdmin = false;
      const res2 = await fetch('/api/calls');
      const data = await res2.json();
      renderCalls(data.calls);
    }

    async function deleteCall(index) {
      const li = document.querySelectorAll("#callList li")[index];
      li.classList.add("fade-out");
      setTimeout(async () => {
        await fetch("/api/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ index })
        });
      }, 400);
    }

    async function resetCalls() {
      const confirmReset = confirm("‚ö†Ô∏è Es-tu s√ªr de vouloir VIDER toute la liste ?");
      if (!confirmReset) return;
      await fetch("/api/reset", { method: "POST" });
    }

    async function submitViewerCall(event) {
      event.preventDefault();
      const slot = document.getElementById("slotInput").value.trim();
      const user = document.getElementById("userInput").value.trim();
      if (!slot || !user) return alert("Remplis les deux champs !");

      const res = await fetch("/api/call", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ slot, user })
      });

      if (res.ok) {
        document.getElementById("slotInput").value = "";
        document.getElementById("userInput").value = "";
        showNotif("Call ajout√© avec succ√®s ‚úÖ");
      } else {
        alert("Erreur lors de l'envoi du call !");
      }
    }
  </script>
  
</body>
</html>
